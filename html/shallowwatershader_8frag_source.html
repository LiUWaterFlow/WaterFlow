<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Waterflow: src/shaders/shallowwatershader.frag Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Waterflow
   
   </div>
   <div id="projectbrief">Visualize water in terrain</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('shallowwatershader_8frag.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/shaders/shallowwatershader.frag</div>  </div>
</div><!--header-->
<div class="contents">
<a href="shallowwatershader_8frag.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#version 430</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span>
<a name="l00006"></a>00006 <span class="comment">// ===== Uniform Buffers =====</span>
<a name="l00007"></a>00007 
<a name="l00013"></a><a class="code" href="struct_light_param.html">00013</a> <span class="keyword">struct </span><a class="code" href="struct_light_param.html">LightParam</a> {
<a name="l00014"></a><a class="code" href="struct_light_param.html#adfbe9e72effb9033d1cba1d67c072c06">00014</a>     vec3 <a class="code" href="struct_light_param.html#adfbe9e72effb9033d1cba1d67c072c06" title="Position of the light.">pos</a>;       
<a name="l00015"></a><a class="code" href="struct_light_param.html#a41d5735172cd50396e8a8ac6d49530c0">00015</a>     <span class="keywordtype">float</span> <a class="code" href="struct_light_param.html#a41d5735172cd50396e8a8ac6d49530c0" title="Is the light directional or not.">isDir</a>;    
<a name="l00016"></a><a class="code" href="struct_light_param.html#a1162fe85cffdbf791838c610b92ba7a8">00016</a>     vec3 <a class="code" href="struct_light_param.html#a1162fe85cffdbf791838c610b92ba7a8" title="Color of the light.">color</a>;     
<a name="l00017"></a><a class="code" href="struct_light_param.html#ab3ad8c95b263f29b214742032d14d228">00017</a>     <span class="keywordtype">float</span> <a class="code" href="struct_light_param.html#ab3ad8c95b263f29b214742032d14d228" title="Specular exponent for the light.">specExp</a>;  
<a name="l00018"></a>00018 };
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="shallowwatershader_8frag.html#a56271a3407e27199724638e64751b923">00020</a> <a class="code" href="add_flow_shader_8comp.html#a38d7d2d84fb7cc382da7b98797a4c70d" title="This should be a nxn, where n is power of 2, however next step would result in 32x32, 1024 threads which is not always supported.">layout</a>(std140, binding = 0) uniform LightInfo 
<a name="l00021"></a>00021 {
<a name="l00022"></a>00022     <a class="code" href="struct_light_param.html">LightParam</a> lights[2];
<a name="l00023"></a><a class="code" href="shallowwatershader_8frag.html#ad5f1108f376121fda3fe33d3deb96000">00023</a> };
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="comment">// ===== Uniforms =====</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 uniform vec3 <a class="code" href="shallowwatershader_8frag.html#ad5f1108f376121fda3fe33d3deb96000" title="Camera position.">camPos</a>;                
<a name="l00029"></a><a class="code" href="shallowwatershader_8frag.html#a63f4df4b0269d312dfa1dfee02b1862e">00029</a> uniform vec3 <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>;                  
<a name="l00030"></a><a class="code" href="shallowwatershader_8frag.html#a251125d5d29683e1458005f28de9845f">00030</a> uniform <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a251125d5d29683e1458005f28de9845f" title="Time variable.">time</a>;                 
<a name="l00031"></a><a class="code" href="shallowwatershader_8frag.html#aa274fe21beb00a2b7c2d82c030c856d0">00031</a> uniform <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#aa274fe21beb00a2b7c2d82c030c856d0" title="Transparency of the water.">transparency</a>;         
<a name="l00032"></a><a class="code" href="shallowwatershader_8frag.html#af0de3ce9fcc74174d2a9d0591a3f5475">00032</a> uniform sampler2D <a class="code" href="shallowwatershader_8frag.html#af0de3ce9fcc74174d2a9d0591a3f5475" title="Terrain (color) texture.">terr_texUnit</a>;     
<a name="l00033"></a><a class="code" href="shallowwatershader_8frag.html#a504f7ef403f348c8afe4a20b9653bec9">00033</a> uniform sampler2D <a class="code" href="depthshader_8frag.html#a504f7ef403f348c8afe4a20b9653bec9" title="Terrain geometry (normal and height) texture.">height_texUnit</a>;   
<a name="l00034"></a><a class="code" href="shallowwatershader_8frag.html#ac5ffbcf0adf772e25a2aa4b4557cc7c3">00034</a> uniform samplerCube <a class="code" href="shallowwatershader_8frag.html#ac5ffbcf0adf772e25a2aa4b4557cc7c3" title="Skybox texture.">sky_texUnit</a>;    
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">// ===== In/Out params =====</span>
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="shallowwatershader_8frag.html#a9aef44521bc8c077f92fa90eae3bd221">00039</a> in vec3 <a class="code" href="shallowwatershader_8frag.html#a9aef44521bc8c077f92fa90eae3bd221" title="Fragment normal.">out_Normal</a>;                 
<a name="l00040"></a><a class="code" href="shallowwatershader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d">00040</a> in vec2 <a class="code" href="depthshader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d" title="Fragment texture coordinate.">out_TexCoord</a>;               
<a name="l00041"></a><a class="code" href="shallowwatershader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc">00041</a> in vec3 <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>;                 
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="shallowwatershader_8frag.html#a0dc90d8afd1e497c842d12d86ece9085">00043</a> out vec4 <a class="code" href="depthshader_8frag.html#a0dc90d8afd1e497c842d12d86ece9085" title="Fragment (out) pixel value.">out_Color</a>;                 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// ===== Variables needed =====</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">// Light vectors</span>
<a name="l00049"></a><a class="code" href="shallowwatershader_8frag.html#a16bd7f237eaea7a9b8fcdb85abe9a669">00049</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a16bd7f237eaea7a9b8fcdb85abe9a669" title="Reflected light vector.">r</a>;                             
<a name="l00050"></a><a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145">00050</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>;                             
<a name="l00051"></a><a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1">00051</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>;                           
<a name="l00052"></a><a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427">00052</a> vec3 <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>;                        
<a name="l00053"></a><a class="code" href="shallowwatershader_8frag.html#a94109a83ad836104b211e08dc68eadb8">00053</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a94109a83ad836104b211e08dc68eadb8" title="Reflected eye vector.">re</a>;                            
<a name="l00054"></a><a class="code" href="shallowwatershader_8frag.html#a80975b382e2f3baa99f6f8d504bdd830">00054</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a80975b382e2f3baa99f6f8d504bdd830" title="Vector to the right (camera position dependent).">right</a>;                         
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">// Lighting (the Phong model with extras).</span>
<a name="l00057"></a><a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338">00057</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338" title="Ambient light coefficient.">kamb</a>;                         
<a name="l00058"></a><a class="code" href="shallowwatershader_8frag.html#a534b0f187964092fa265b862effad631">00058</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a534b0f187964092fa265b862effad631" title="Diffuse light coefficient.">kdiff</a>;                        
<a name="l00059"></a><a class="code" href="shallowwatershader_8frag.html#acc40b70aa60fc25df46539de9fdbe78f">00059</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#acc40b70aa60fc25df46539de9fdbe78f" title="Transparent light (red channel) coefficient.">ktransr</a>;                      
<a name="l00060"></a><a class="code" href="shallowwatershader_8frag.html#a3350fcc192f97ba2b13d6d4295b3209f">00060</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a3350fcc192f97ba2b13d6d4295b3209f" title="Transparent light (green channel) coefficient.">ktransg</a>;                      
<a name="l00061"></a><a class="code" href="shallowwatershader_8frag.html#a37e43f2baa4cd7cec3c0efabf307cc32">00061</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a37e43f2baa4cd7cec3c0efabf307cc32" title="Transparent light (blue channel) coefficient.">ktransb</a>;                      
<a name="l00062"></a><a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad">00062</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad" title="Reflected light coefficient.">krefl</a>;                        
<a name="l00063"></a><a class="code" href="shallowwatershader_8frag.html#add5bc8653e190b7637ea8c614ba57eda">00063</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#add5bc8653e190b7637ea8c614ba57eda" title="&quot;Blueness&quot; coefficient.">kblue</a>;                        
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412">00065</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412" title="Ambient light color.">ambLight</a>;                      
<a name="l00066"></a><a class="code" href="shallowwatershader_8frag.html#a510b10bbd0c89d520ea6b3b74dae3118">00066</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a510b10bbd0c89d520ea6b3b74dae3118" title="Diffuse light color.">diffLight</a>;                     
<a name="l00067"></a><a class="code" href="shallowwatershader_8frag.html#a55dd81c3ff59be2cea5f141352957cbb">00067</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a55dd81c3ff59be2cea5f141352957cbb" title="Specular light color.">specLight</a>;                     
<a name="l00068"></a><a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917">00068</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a>;                     
<a name="l00069"></a><a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60">00069</a> vec3 <a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60" title="Total surface light color.">surfaceLight</a>;                  
<a name="l00070"></a><a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde">00070</a> vec3 <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a>;                   
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">// Snell&#39;s law angles.</span>
<a name="l00073"></a><a class="code" href="shallowwatershader_8frag.html#a7011209d6553df74d513f0a6c956e7e1">00073</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a7011209d6553df74d513f0a6c956e7e1" title="Incident light angle (from camera to bottom).">theta1</a>;                       
<a name="l00074"></a><a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4">00074</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4" title="Refracted light angle (from camera to bottom).">theta2</a>;                       
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">// Underwater triangulation components.</span>
<a name="l00077"></a><a class="code" href="shallowwatershader_8frag.html#a845896541a0621f5fbd11f0d115ce463">00077</a> <span class="keywordtype">float</span> <a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a>;                        
<a name="l00078"></a><a class="code" href="shallowwatershader_8frag.html#aceec6bb374022e8a25abca4a2e2e6c09">00078</a> vec3 <a class="code" href="shallowwatershader_8frag.html#aceec6bb374022e8a25abca4a2e2e6c09" title="Refraction direction in the xz-plane.">displacementDirection</a>;         
<a name="l00079"></a><a class="code" href="shallowwatershader_8frag.html#a7657d7304a729dc33cce22f647b7f293">00079</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a7657d7304a729dc33cce22f647b7f293" title="Distance to displace along the bottom for the first approximation.">bottomDisplacement1</a>;          
<a name="l00080"></a><a class="code" href="shallowwatershader_8frag.html#a10d40d1804789057b727b907c40ed46d">00080</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a10d40d1804789057b727b907c40ed46d" title="Displacement vector (first approximation).">displacement1</a>;                 
<a name="l00081"></a><a class="code" href="shallowwatershader_8frag.html#a752e5a7fd288f9a63cd779d466b8cb82">00081</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a752e5a7fd288f9a63cd779d466b8cb82" title="Depth at first displacement approximation.">depthAtDis1</a>;                  
<a name="l00082"></a><a class="code" href="shallowwatershader_8frag.html#a85f2f1bd58b3b44ffdf3881823393959">00082</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a85f2f1bd58b3b44ffdf3881823393959" title="Height at first approximation.">h</a>;                            
<a name="l00083"></a><a class="code" href="shallowwatershader_8frag.html#ab1551d8043c2aa4410fb7dbb1fe3be7b">00083</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#ab1551d8043c2aa4410fb7dbb1fe3be7b" title="Angle used for refraction approximation.">alpha</a>;                        
<a name="l00084"></a><a class="code" href="shallowwatershader_8frag.html#a911881a8d2cb6e8ccfca5a6880981412">00084</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a911881a8d2cb6e8ccfca5a6880981412" title="Better displacement approximation distance.">bottomDisplacement2</a>;          
<a name="l00085"></a><a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24">00085</a> vec3 <a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a>;                 
<a name="l00086"></a><a class="code" href="shallowwatershader_8frag.html#a7b82ad065848cc07d9e5ec736729b004">00086</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a7b82ad065848cc07d9e5ec736729b004" title="Depth at better approximation.">depthAtDis2</a>;                  
<a name="l00087"></a><a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b">00087</a> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b" title="Distance from surface to better approximation.">wdist</a>;                        
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226">00089</a> vec3 <a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226" title="Position of seen bottom.">bottomPos</a>;                     
<a name="l00090"></a><a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467">00090</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467" title="Normal of seen bottom.">bottomNormal</a>;                  
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="comment">// Texture lookups.</span>
<a name="l00093"></a><a class="code" href="shallowwatershader_8frag.html#a94bb0fc1c5e92ba5a0c6ce048e713606">00093</a> vec4 <a class="code" href="depthshader_8frag.html#a94bb0fc1c5e92ba5a0c6ce048e713606" title="Terrain geometry under fragment.">terrainDataUnderSurface</a>;       
<a name="l00094"></a><a class="code" href="shallowwatershader_8frag.html#a7f8c385258122384ccac0cea3374aacd">00094</a> vec4 <a class="code" href="shallowwatershader_8frag.html#a7f8c385258122384ccac0cea3374aacd" title="Terrain geometry at first approximation.">terrainDataAtDis1</a>;             
<a name="l00095"></a><a class="code" href="shallowwatershader_8frag.html#aa253094664bd31dbe7fd68caac764bdc">00095</a> vec4 <a class="code" href="shallowwatershader_8frag.html#aa253094664bd31dbe7fd68caac764bdc" title="Terrain geometry at better approximation.">terrainDataAtBottom</a>;           
<a name="l00096"></a><a class="code" href="shallowwatershader_8frag.html#adba2f34cc2efc608ad99c31f190d3d31">00096</a> vec4 <a class="code" href="shallowwatershader_8frag.html#adba2f34cc2efc608ad99c31f190d3d31" title="Terrain color at bottom.">texDataAtBottom</a>;               
<a name="l00097"></a><a class="code" href="shallowwatershader_8frag.html#a0804642326575da51335b635b80ab046">00097</a> vec3 <a class="code" href="shallowwatershader_8frag.html#a0804642326575da51335b635b80ab046" title="Skybox color.">skyrefl</a>;                       
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">// Constants</span>
<a name="l00100"></a><a class="code" href="shallowwatershader_8frag.html#a636cdc504adb24e9d6769b0245e84fd0">00100</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#a636cdc504adb24e9d6769b0245e84fd0" title="Refraction index of water.">waterRefInd</a> = 1.34451;  
<a name="l00101"></a><a class="code" href="shallowwatershader_8frag.html#ac7b706a6ddcead1759d995bc262a84b6">00101</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="shallowwatershader_8frag.html#ac7b706a6ddcead1759d995bc262a84b6" title="Refraction index of air.">airRefInd</a> = 1.0;        
<a name="l00102"></a><a class="code" href="shallowwatershader_8frag.html#a21963c1b8a6f6a8fc16e912adf113be8">00102</a> <span class="keyword">const</span> vec3 <a class="code" href="shallowwatershader_8frag.html#a21963c1b8a6f6a8fc16e912adf113be8" title="Up vector (world coordinates).">up</a> = vec3(0.0, 1.0, 0.0);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="keywordtype">void</span> main(<span class="keywordtype">void</span>)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <span class="comment">// eye vector is calculated.</span>
<a name="l00107"></a>00107     <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a> = normalize(<a class="code" href="shallowwatershader_8frag.html#ad5f1108f376121fda3fe33d3deb96000" title="Camera position.">camPos</a> - <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="comment">// Get the normal</span>
<a name="l00110"></a>00110     <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a> = normalize(<a class="code" href="shallowwatershader_8frag.html#a9aef44521bc8c077f92fa90eae3bd221" title="Fragment normal.">out_Normal</a>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="comment">// Incident and reflected light is calculated for the light source.</span>
<a name="l00113"></a>00113     <a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a> = normalize(lights[0].pos - (1 - lights[0].isDir) * <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>);
<a name="l00114"></a>00114     <a class="code" href="shallowwatershader_8frag.html#a16bd7f237eaea7a9b8fcdb85abe9a669" title="Reflected light vector.">r</a> = normalize(2 * <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a> * dot(<a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>, <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>) - <a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <a class="code" href="shallowwatershader_8frag.html#a80975b382e2f3baa99f6f8d504bdd830" title="Vector to the right (camera position dependent).">right</a> = cross(<a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>, <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>);
<a name="l00117"></a>00117     <span class="comment">// Snell&#39;s law</span>
<a name="l00118"></a>00118     <span class="comment">// Since asin is not that cheap, approximations could be made here.</span>
<a name="l00119"></a>00119     <a class="code" href="shallowwatershader_8frag.html#a7011209d6553df74d513f0a6c956e7e1" title="Incident light angle (from camera to bottom).">theta1</a> = asin(length(<a class="code" href="shallowwatershader_8frag.html#a80975b382e2f3baa99f6f8d504bdd830" title="Vector to the right (camera position dependent).">right</a>));
<a name="l00120"></a>00120     <a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4" title="Refracted light angle (from camera to bottom).">theta2</a> = asin(<a class="code" href="shallowwatershader_8frag.html#ac7b706a6ddcead1759d995bc262a84b6" title="Refraction index of air.">airRefInd</a> * sin(<a class="code" href="shallowwatershader_8frag.html#a7011209d6553df74d513f0a6c956e7e1" title="Incident light angle (from camera to bottom).">theta1</a>) / <a class="code" href="shallowwatershader_8frag.html#a636cdc504adb24e9d6769b0245e84fd0" title="Refraction index of water.">waterRefInd</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">// Texture lookup at fragment.</span>
<a name="l00123"></a>00123     <a class="code" href="depthshader_8frag.html#a94bb0fc1c5e92ba5a0c6ce048e713606" title="Terrain geometry under fragment.">terrainDataUnderSurface</a> = texture(<a class="code" href="depthshader_8frag.html#a504f7ef403f348c8afe4a20b9653bec9" title="Terrain geometry (normal and height) texture.">height_texUnit</a>, <a class="code" href="depthshader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d" title="Fragment texture coordinate.">out_TexCoord</a>);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">// Depth at fragment.</span>
<a name="l00126"></a>00126     <a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a> = <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.y - <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.y * <a class="code" href="depthshader_8frag.html#a94bb0fc1c5e92ba5a0c6ce048e713606" title="Terrain geometry under fragment.">terrainDataUnderSurface</a>.a;
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (<a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a> &lt; 0 || <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.z &lt; 1 || <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.x &lt; 1 )
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130         discard;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">// To find the fragment at the bottom corresponding to what would be seen after refraction</span>
<a name="l00134"></a>00134     <span class="comment">// at the water surface, a crude displacement approximation in the xz-plane from the surface</span>
<a name="l00135"></a>00135     <span class="comment">// fragment to the approximated fragment at the bottom is calculated.</span>
<a name="l00136"></a>00136     vec3 s2 = <a class="code" href="shallowwatershader_8frag.html#ac7b706a6ddcead1759d995bc262a84b6" title="Refraction index of air.">airRefInd</a> / <a class="code" href="shallowwatershader_8frag.html#a636cdc504adb24e9d6769b0245e84fd0" title="Refraction index of water.">waterRefInd</a> * cross(<a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>, cross(<a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>, <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>)) - <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a> * sqrt(1 - pow(<a class="code" href="shallowwatershader_8frag.html#ac7b706a6ddcead1759d995bc262a84b6" title="Refraction index of air.">airRefInd</a> / <a class="code" href="shallowwatershader_8frag.html#a636cdc504adb24e9d6769b0245e84fd0" title="Refraction index of water.">waterRefInd</a>, 2) * dot(cross(<a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>, <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>), cross(<a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>, <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>)));
<a name="l00137"></a>00137     <a class="code" href="shallowwatershader_8frag.html#aceec6bb374022e8a25abca4a2e2e6c09" title="Refraction direction in the xz-plane.">displacementDirection</a> = normalize(s2 - dot(s2, -<a class="code" href="shallowwatershader_8frag.html#a21963c1b8a6f6a8fc16e912adf113be8" title="Up vector (world coordinates).">up</a>) * -<a class="code" href="shallowwatershader_8frag.html#a21963c1b8a6f6a8fc16e912adf113be8" title="Up vector (world coordinates).">up</a>);
<a name="l00138"></a>00138     <a class="code" href="shallowwatershader_8frag.html#a7657d7304a729dc33cce22f647b7f293" title="Distance to displace along the bottom for the first approximation.">bottomDisplacement1</a> = tan(<a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4" title="Refracted light angle (from camera to bottom).">theta2</a>) * <a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a>;
<a name="l00139"></a>00139     <a class="code" href="shallowwatershader_8frag.html#a10d40d1804789057b727b907c40ed46d" title="Displacement vector (first approximation).">displacement1</a> = <a class="code" href="shallowwatershader_8frag.html#a7657d7304a729dc33cce22f647b7f293" title="Distance to displace along the bottom for the first approximation.">bottomDisplacement1</a> * <a class="code" href="shallowwatershader_8frag.html#aceec6bb374022e8a25abca4a2e2e6c09" title="Refraction direction in the xz-plane.">displacementDirection</a>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">// Texture lookup at approximation.</span>
<a name="l00142"></a>00142     <a class="code" href="shallowwatershader_8frag.html#a7f8c385258122384ccac0cea3374aacd" title="Terrain geometry at first approximation.">terrainDataAtDis1</a> = texture(<a class="code" href="depthshader_8frag.html#a504f7ef403f348c8afe4a20b9653bec9" title="Terrain geometry (normal and height) texture.">height_texUnit</a>, <a class="code" href="depthshader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d" title="Fragment texture coordinate.">out_TexCoord</a> + vec2(<a class="code" href="shallowwatershader_8frag.html#a10d40d1804789057b727b907c40ed46d" title="Displacement vector (first approximation).">displacement1</a>.x / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.x, <a class="code" href="shallowwatershader_8frag.html#a10d40d1804789057b727b907c40ed46d" title="Displacement vector (first approximation).">displacement1</a>.z / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.z));
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">// &quot;Depth&quot; at approximation.</span>
<a name="l00145"></a>00145     <a class="code" href="shallowwatershader_8frag.html#a752e5a7fd288f9a63cd779d466b8cb82" title="Depth at first displacement approximation.">depthAtDis1</a> = <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.y - <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.y * <a class="code" href="shallowwatershader_8frag.html#a7f8c385258122384ccac0cea3374aacd" title="Terrain geometry at first approximation.">terrainDataAtDis1</a>.a;
<a name="l00146"></a>00146     <span class="comment">// Height at approximation (y distance from fragment bottom to approximation bottom).</span>
<a name="l00147"></a>00147     <a class="code" href="shallowwatershader_8frag.html#a85f2f1bd58b3b44ffdf3881823393959" title="Height at first approximation.">h</a> = <a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a> - <a class="code" href="shallowwatershader_8frag.html#a752e5a7fd288f9a63cd779d466b8cb82" title="Depth at first displacement approximation.">depthAtDis1</a>;
<a name="l00148"></a>00148     <span class="comment">// To minimize visual errors caused by irregular terrain, a better approximation is made.</span>
<a name="l00149"></a>00149     <a class="code" href="shallowwatershader_8frag.html#ab1551d8043c2aa4410fb7dbb1fe3be7b" title="Angle used for refraction approximation.">alpha</a> = abs(atan(<a class="code" href="shallowwatershader_8frag.html#a85f2f1bd58b3b44ffdf3881823393959" title="Height at first approximation.">h</a> / <a class="code" href="shallowwatershader_8frag.html#a7657d7304a729dc33cce22f647b7f293" title="Distance to displace along the bottom for the first approximation.">bottomDisplacement1</a>));
<a name="l00150"></a>00150     <a class="code" href="shallowwatershader_8frag.html#a911881a8d2cb6e8ccfca5a6880981412" title="Better displacement approximation distance.">bottomDisplacement2</a> = cos(<a class="code" href="shallowwatershader_8frag.html#ab1551d8043c2aa4410fb7dbb1fe3be7b" title="Angle used for refraction approximation.">alpha</a>) * <a class="code" href="depthshader_8frag.html#a845896541a0621f5fbd11f0d115ce463" title="Water depth at fragment.">depth</a> * sin(<a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4" title="Refracted light angle (from camera to bottom).">theta2</a>) / cos(<a class="code" href="shallowwatershader_8frag.html#ab1551d8043c2aa4410fb7dbb1fe3be7b" title="Angle used for refraction approximation.">alpha</a> - <a class="code" href="shallowwatershader_8frag.html#a6f55ee205d99fea441d78d90faddd2b4" title="Refracted light angle (from camera to bottom).">theta2</a>);
<a name="l00151"></a>00151     <a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a> = <a class="code" href="shallowwatershader_8frag.html#a911881a8d2cb6e8ccfca5a6880981412" title="Better displacement approximation distance.">bottomDisplacement2</a> * <a class="code" href="shallowwatershader_8frag.html#aceec6bb374022e8a25abca4a2e2e6c09" title="Refraction direction in the xz-plane.">displacementDirection</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">// Texture lookups at better approximation.</span>
<a name="l00154"></a>00154     <a class="code" href="shallowwatershader_8frag.html#aa253094664bd31dbe7fd68caac764bdc" title="Terrain geometry at better approximation.">terrainDataAtBottom</a> = texture(<a class="code" href="depthshader_8frag.html#a504f7ef403f348c8afe4a20b9653bec9" title="Terrain geometry (normal and height) texture.">height_texUnit</a>, <a class="code" href="depthshader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d" title="Fragment texture coordinate.">out_TexCoord</a> + vec2(<a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a>.x / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.x, <a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a>.z / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.z));
<a name="l00155"></a>00155     <a class="code" href="shallowwatershader_8frag.html#adba2f34cc2efc608ad99c31f190d3d31" title="Terrain color at bottom.">texDataAtBottom</a> = texture(<a class="code" href="shallowwatershader_8frag.html#af0de3ce9fcc74174d2a9d0591a3f5475" title="Terrain (color) texture.">terr_texUnit</a>, <a class="code" href="depthshader_8frag.html#a4a88bada04274f33f37d505f2b0ae42d" title="Fragment texture coordinate.">out_TexCoord</a> + vec2(<a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a>.x / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.x, <a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a>.z / <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.z));
<a name="l00156"></a>00156     <span class="comment">// &quot;Depth&quot; at better approximation.</span>
<a name="l00157"></a>00157     <a class="code" href="shallowwatershader_8frag.html#a7b82ad065848cc07d9e5ec736729b004" title="Depth at better approximation.">depthAtDis2</a> = <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.y - <a class="code" href="add_flow_shader_8comp.html#aed22e6adc3355ad6b2430d85fd5c481e" title="width height">size</a>.y * <a class="code" href="shallowwatershader_8frag.html#aa253094664bd31dbe7fd68caac764bdc" title="Terrain geometry at better approximation.">terrainDataAtBottom</a>.a;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">// Coordinates and normal of seen position of bottom.</span>
<a name="l00160"></a>00160     <a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226" title="Position of seen bottom.">bottomPos</a> = <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a> + <a class="code" href="shallowwatershader_8frag.html#afa72e0ef9ee018f933b0fe5aaa100b24" title="Better displacement approximation vector.">displacement2</a> - vec3(0, <a class="code" href="shallowwatershader_8frag.html#a7b82ad065848cc07d9e5ec736729b004" title="Depth at better approximation.">depthAtDis2</a>, 0);
<a name="l00161"></a>00161     <a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467" title="Normal of seen bottom.">bottomNormal</a> = normalize(<a class="code" href="shallowwatershader_8frag.html#aa253094664bd31dbe7fd68caac764bdc" title="Terrain geometry at better approximation.">terrainDataAtBottom</a>.rgb);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="comment">// Distance from surface to seen position of bottom.</span>
<a name="l00164"></a>00164     <a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b" title="Distance from surface to better approximation.">wdist</a> = length(<a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226" title="Position of seen bottom.">bottomPos</a> - <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>);
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     <span class="comment">// Skybox reflection.</span>
<a name="l00167"></a>00167     <span class="comment">// Reflected eye vector.</span>
<a name="l00168"></a>00168     <a class="code" href="shallowwatershader_8frag.html#a94109a83ad836104b211e08dc68eadb8" title="Reflected eye vector.">re</a> = 2 * dot(<a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>, <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a>) * <a class="code" href="shallowwatershader_8frag.html#ac1b9cfb0a6f22733d035e450c49e7427" title="(Modified) fragment normal.">Normal</a> - <a class="code" href="shallowwatershader_8frag.html#a59c7cca5ec718e42f0b3d58b033932c1" title="Vector from the fragment to the camera.">eye</a>;
<a name="l00169"></a>00169     <a class="code" href="shallowwatershader_8frag.html#a0804642326575da51335b635b80ab046" title="Skybox color.">skyrefl</a> = texture(<a class="code" href="shallowwatershader_8frag.html#ac5ffbcf0adf772e25a2aa4b4557cc7c3" title="Skybox texture.">sky_texUnit</a>, <a class="code" href="shallowwatershader_8frag.html#a94109a83ad836104b211e08dc68eadb8" title="Reflected eye vector.">re</a>).rgb;
<a name="l00170"></a>00170     <span class="comment">// Light components, water surface.</span>
<a name="l00171"></a>00171     <a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338" title="Ambient light coefficient.">kamb</a> = 0.1;
<a name="l00172"></a>00172     <a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad" title="Reflected light coefficient.">krefl</a> = clamp((1 - eye.y), 0.2, 0.7);
<a name="l00173"></a>00173     <span class="comment">// Ambient light.</span>
<a name="l00174"></a>00174     <a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412" title="Ambient light color.">ambLight</a> = <a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338" title="Ambient light coefficient.">kamb</a> * vec3(1.0, 1.0, 1.0);
<a name="l00175"></a>00175     <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a> = vec3(0.0, 0.0, 0.0);
<a name="l00176"></a>00176     <span class="comment">// Reflected light.</span>
<a name="l00177"></a>00177     <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a> += <a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad" title="Reflected light coefficient.">krefl</a> * <a class="code" href="shallowwatershader_8frag.html#a0804642326575da51335b635b80ab046" title="Skybox color.">skyrefl</a>;
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     <a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60" title="Total surface light color.">surfaceLight</a> = vec3(0.0, 0.0, 0.0);
<a name="l00180"></a>00180     <span class="comment">// The light components are added to the total surface light.</span>
<a name="l00181"></a>00181     <a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60" title="Total surface light color.">surfaceLight</a> += <a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412" title="Ambient light color.">ambLight</a>;
<a name="l00182"></a>00182     <a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60" title="Total surface light color.">surfaceLight</a> += <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a>;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="shallowwatershader_8frag.html#acc40b70aa60fc25df46539de9fdbe78f" title="Transparent light (red channel) coefficient.">ktransr</a> = clamp((1 - <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a>.r) * pow((1 + <a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b" title="Distance from surface to better approximation.">wdist</a>), -1.8 * <a class="code" href="shallowwatershader_8frag.html#aa274fe21beb00a2b7c2d82c030c856d0" title="Transparency of the water.">transparency</a>), 0.0, 0.5);
<a name="l00185"></a>00185     <a class="code" href="shallowwatershader_8frag.html#a3350fcc192f97ba2b13d6d4295b3209f" title="Transparent light (green channel) coefficient.">ktransg</a> = clamp((1 - <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a>.g) * pow((1 + <a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b" title="Distance from surface to better approximation.">wdist</a>), -1.7 * <a class="code" href="shallowwatershader_8frag.html#aa274fe21beb00a2b7c2d82c030c856d0" title="Transparency of the water.">transparency</a>), 0.0, 0.5);
<a name="l00186"></a>00186     <a class="code" href="shallowwatershader_8frag.html#a37e43f2baa4cd7cec3c0efabf307cc32" title="Transparent light (blue channel) coefficient.">ktransb</a> = clamp((1 - <a class="code" href="shallowwatershader_8frag.html#a4ab9f2876c70ef76a2097c1018ab5917" title="Reflected light (skybox) color.">reflLight</a>.b) * pow((1 + <a class="code" href="shallowwatershader_8frag.html#a0606d6d6b27ef2061761ee49dab3853b" title="Distance from surface to better approximation.">wdist</a>), -1.5 * <a class="code" href="shallowwatershader_8frag.html#aa274fe21beb00a2b7c2d82c030c856d0" title="Transparency of the water.">transparency</a>), 0.0, 0.5);
<a name="l00187"></a>00187     <a class="code" href="shallowwatershader_8frag.html#add5bc8653e190b7637ea8c614ba57eda" title="&quot;Blueness&quot; coefficient.">kblue</a> = 1 - eye.y;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="comment">// Calculating bottom light.</span>
<a name="l00190"></a>00190     <span class="comment">// Phong shading for the bottom.</span>
<a name="l00191"></a>00191     <a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a> = normalize(lights[1].pos - (1 - lights[1].isDir) * <a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226" title="Position of seen bottom.">bottomPos</a>);
<a name="l00192"></a>00192     <a class="code" href="shallowwatershader_8frag.html#a16bd7f237eaea7a9b8fcdb85abe9a669" title="Reflected light vector.">r</a> = normalize(2 * <a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467" title="Normal of seen bottom.">bottomNormal</a> * dot(<a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>, <a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467" title="Normal of seen bottom.">bottomNormal</a>) - <a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">// eye vector is calculated (note: from bottom to surface, not to camera).</span>
<a name="l00195"></a>00195     eye = normalize(<a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a> - <a class="code" href="shallowwatershader_8frag.html#aee8a4902cdd4ab23aee70c7f8c450226" title="Position of seen bottom.">bottomPos</a>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="comment">// Light according to the Phong model.</span>
<a name="l00198"></a>00198     <a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338" title="Ambient light coefficient.">kamb</a> = 0.1;
<a name="l00199"></a>00199     <a class="code" href="shallowwatershader_8frag.html#a534b0f187964092fa265b862effad631" title="Diffuse light coefficient.">kdiff</a> = 0.5;
<a name="l00200"></a>00200     <a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad" title="Reflected light coefficient.">krefl</a> = 0.5;
<a name="l00201"></a>00201     <a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412" title="Ambient light color.">ambLight</a> = <a class="code" href="shallowwatershader_8frag.html#ac79d189182b7dae83dde63c53c99a338" title="Ambient light coefficient.">kamb</a> * vec3(1.0, 1.0, 1.0);
<a name="l00202"></a>00202     <a class="code" href="shallowwatershader_8frag.html#a510b10bbd0c89d520ea6b3b74dae3118" title="Diffuse light color.">diffLight</a> = vec3(0.0, 0.0, 0.0);
<a name="l00203"></a>00203     <a class="code" href="shallowwatershader_8frag.html#a55dd81c3ff59be2cea5f141352957cbb" title="Specular light color.">specLight</a> = vec3(0.0, 0.0, 0.0);
<a name="l00204"></a>00204     <span class="comment">// Diffuse light.</span>
<a name="l00205"></a>00205     <a class="code" href="shallowwatershader_8frag.html#a510b10bbd0c89d520ea6b3b74dae3118" title="Diffuse light color.">diffLight</a> += <a class="code" href="shallowwatershader_8frag.html#a534b0f187964092fa265b862effad631" title="Diffuse light coefficient.">kdiff</a> * lights[1].color * max(0.0, dot(<a class="code" href="shallowwatershader_8frag.html#a1196de69544a2f154d290caa143b0145" title="Incident light vector.">s</a>, <a class="code" href="shallowwatershader_8frag.html#a3cdc84f75a91707df9b5479956830467" title="Normal of seen bottom.">bottomNormal</a>));
<a name="l00206"></a>00206     <span class="comment">// Specular light.</span>
<a name="l00207"></a>00207     <a class="code" href="shallowwatershader_8frag.html#a55dd81c3ff59be2cea5f141352957cbb" title="Specular light color.">specLight</a> += <a class="code" href="shallowwatershader_8frag.html#ab6d28c8ee242bc3ebc2ab569ffe3e5ad" title="Reflected light coefficient.">krefl</a> * lights[1].color * max(0.0, pow(dot(<a class="code" href="shallowwatershader_8frag.html#a16bd7f237eaea7a9b8fcdb85abe9a669" title="Reflected light vector.">r</a>, eye), lights[1].specExp));
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> = vec3(0.0, 0.0, 0.0);
<a name="l00210"></a>00210     <span class="comment">// The light components are added to the total bottom light.</span>
<a name="l00211"></a>00211     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> += <a class="code" href="shallowwatershader_8frag.html#a472f5a950fb37468d4c7063e1a66c412" title="Ambient light color.">ambLight</a>;
<a name="l00212"></a>00212     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> += <a class="code" href="shallowwatershader_8frag.html#a510b10bbd0c89d520ea6b3b74dae3118" title="Diffuse light color.">diffLight</a>;
<a name="l00213"></a>00213     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> += <a class="code" href="shallowwatershader_8frag.html#a55dd81c3ff59be2cea5f141352957cbb" title="Specular light color.">specLight</a>;
<a name="l00214"></a>00214     
<a name="l00215"></a>00215     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> *= <a class="code" href="shallowwatershader_8frag.html#adba2f34cc2efc608ad99c31f190d3d31" title="Terrain color at bottom.">texDataAtBottom</a>.rgb;
<a name="l00216"></a>00216     <span class="comment">//Color dependant attenuation.</span>
<a name="l00217"></a>00217     <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> = vec3(<a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a>.r * <a class="code" href="shallowwatershader_8frag.html#acc40b70aa60fc25df46539de9fdbe78f" title="Transparent light (red channel) coefficient.">ktransr</a>, <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a>.g * <a class="code" href="shallowwatershader_8frag.html#a3350fcc192f97ba2b13d6d4295b3209f" title="Transparent light (green channel) coefficient.">ktransg</a>, <a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a>.b * <a class="code" href="shallowwatershader_8frag.html#a37e43f2baa4cd7cec3c0efabf307cc32" title="Transparent light (blue channel) coefficient.">ktransb</a>);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (<a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.y &gt; 35.0f || <a class="code" href="depthshader_8frag.html#a8a5f78384762d4e4864ee4f3b5ad82fc" title="Fragment position.">out_ObjPos</a>.y &lt; 0.000000005f) {
<a name="l00220"></a>00220         vec3 brown = vec3(250, 184,173);
<a name="l00221"></a>00221         brown = 0.3*normalize(brown);
<a name="l00222"></a>00222         <a class="code" href="depthshader_8frag.html#a0dc90d8afd1e497c842d12d86ece9085" title="Fragment (out) pixel value.">out_Color</a> = vec4(brown,1);
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224     <span class="keywordflow">else</span>{
<a name="l00225"></a>00225         <a class="code" href="depthshader_8frag.html#a0dc90d8afd1e497c842d12d86ece9085" title="Fragment (out) pixel value.">out_Color</a> = vec4(<a class="code" href="shallowwatershader_8frag.html#ad07d8d131c1aae0032d32a2475219dde" title="Total bottom light color.">bottomLight</a> + <a class="code" href="shallowwatershader_8frag.html#acfbcfd962c029a5c0439dddbc5272b60" title="Total surface light color.">surfaceLight</a>, 1.0);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="shallowwatershader_8frag.html">shallowwatershader.frag</a>      </li>

    <li class="footer">Generated on Mon Dec 21 2015 22:52:48 for Waterflow by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
